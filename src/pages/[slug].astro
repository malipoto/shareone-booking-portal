---
/**
 * SSR Booking Page — fetches data from Supabase at request time.
 */

const { slug } = Astro.params;

const functionsUrl = import.meta.env.SUPABASE_FUNCTIONS_URL || 'https://zhzwbkoxjdiiqaaakipr.supabase.co/functions/v1';
const anonKey = import.meta.env.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpoendia294amRpaXFhYWFraXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTk5ODAsImV4cCI6MjA4NDMzNTk4MH0.hpZazQveVWnTtHNs6Ogb5vLWlpODS8RrxFOSyb9h5N0';

let page: any = null;
let error = false;

try {
  const res = await fetch(`${functionsUrl}/get-booking-page?slug=${encodeURIComponent(slug!)}`, {
    headers: {
      'apikey': anonKey,
      'Authorization': `Bearer ${anonKey}`,
    },
  });
  if (res.ok) {
    page = await res.json();
  } else {
    error = true;
  }
} catch (e) {
  error = true;
}

if (error || !page) {
  return Astro.redirect('/404');
}

const mainHeader = page.booking_main_header || "Let's Capture Your Story Together";
const headerSubtext = page.booking_header_subtext || "You're invited to a relaxed 20-minute virtual conversation with one of our trained guides. This is not a performance or a pitch, just a genuine conversation. Join from your computer or phone, find a quiet space, and show up as yourself. We will guide you through everything and take care of the rest.";
const headline = page.booking_headline || `Interview Invitation for ${page.client_name}`;
const description = page.booking_body_text || `Thank you for saying yes. Your experience matters, and your story has the power to inspire others who are considering ${page.client_name}. We are honored to listen, learn, and help you share what made your experience meaningful.`;
const clientName = page.client_name || page.name;
const isAccepting = page.is_active !== false && page.landing_page_published !== false;

// Calendly embed detection
const isCalendlyEmbed = page.calendly_link?.includes('<div') || page.calendly_link?.includes('calendly-inline-widget');
const calendlyUrl = !isCalendlyEmbed ? page.calendly_link : null;

const utmParams = `utm_source=${encodeURIComponent(clientName)}&utm_campaign=${encodeURIComponent(page.name)}&utm_content=${page.id}`;

let calendlyEmbedHtml = '';
if (isCalendlyEmbed && page.calendly_link) {
  calendlyEmbedHtml = page.calendly_link.replace(
    /data-url="([^"]+)"/,
    (_match, url) => {
      const separator = url.includes('?') ? '&' : '?';
      return `data-url="${url}${separator}${utmParams}"`;
    }
  );
}

// Cache this page for 60s, serve stale for 5min while revalidating
Astro.response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=300');
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{mainHeader} &mdash; {clientName} | Share One</title>
  <meta name="description" content={headerSubtext.slice(0, 155)} />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --color-bg: #FAFAF8;
      --color-surface: #FFFFFF;
      --color-navy: #1E3A8A;
      --color-text: #1F2937;
      --color-text-secondary: #6B7280;
      --color-text-muted: #9CA3AF;
      --color-accent: #2563EB;
      --color-border: #E5E7EB;
      --color-border-light: #F3F4F6;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --font-display: 'DM Serif Display', Georgia, serif;
    }

    body {
      font-family: var(--font-body);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Combined Header + Banner */
    .header-banner {
      background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-accent) 100%);
    }
    .header {
      height: 72px;
      display: flex;
      align-items: center;
      padding: 0 32px;
    }
    .header img { height: 32px; }
    .headline-banner {
      padding: 24px 24px 48px;
      text-align: center;
    }
    .headline-banner-inner {
      max-width: 720px;
      margin: 0 auto;
    }
    .headline-banner h1 {
      font-family: var(--font-display);
      font-size: clamp(28px, 5vw, 44px);
      font-weight: 400;
      line-height: 1.2;
      color: #FFFFFF;
      margin-bottom: 16px;
    }
    .headline-banner .banner-description {
      font-size: 18px;
      line-height: 1.7;
      color: rgba(255,255,255,0.85);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Hero */
    .hero {
      background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-border-light) 100%);
      padding: 60px 24px;
    }
    .hero-inner {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 48px;
      align-items: center;
    }
    .invitation-headline {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--color-text-muted);
      margin-bottom: 12px;
    }
    .invitation-description {
      font-size: 16px;
      line-height: 1.7;
      color: #4B5563;
      max-width: 500px;
    }
    .logo-card {
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.1);
      background: var(--color-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      border: 1px solid var(--color-border);
    }
    .logo-card img {
      width: 80%;
      max-height: 280px;
      object-fit: contain;
    }

    /* Quick Tips */
    .tips-section { padding: 0 24px 80px; }
    .tips-inner { max-width: 960px; margin: 0 auto; }
    .tips-toggle {
      width: 100%;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      padding: 24px 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: var(--font-display);
      font-size: 24px;
      color: var(--color-text);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
      transition: border-radius 0.2s;
    }
    .tips-toggle[aria-expanded="true"] {
      border-radius: 20px 20px 0 0;
    }
    .tips-toggle svg {
      width: 22px; height: 22px;
      stroke: var(--color-text-muted);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .tips-content {
      display: none;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-top: none;
      border-radius: 0 0 20px 20px;
      padding: 28px 32px 36px;
    }
    .tips-content.open { display: block; }
    .tips-subheading {
      font-size: 18px;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 28px;
    }
    .tips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 36px;
    }
    .tips-grid h4 {
      font-family: var(--font-body);
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 16px;
    }
    .tips-grid ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 15px;
      color: #4B5563;
      line-height: 2;
    }
    .tips-grid li {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .bullet {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-accent);
      flex-shrink: 0;
      margin-top: 7px;
    }
    .tips-footer {
      margin-top: 24px;
      font-size: 15px;
      color: var(--color-text-muted);
      font-style: italic;
    }

    /* Scheduling */
    .schedule-section { padding: 0 24px 80px; }
    .schedule-inner { max-width: 960px; margin: 0 auto; text-align: center; }
    .schedule-inner h2 {
      font-family: var(--font-display);
      font-size: clamp(28px, 4vw, 36px);
      color: var(--color-text);
      margin-bottom: 12px;
    }
    .schedule-inner .subtitle {
      font-size: 18px;
      color: var(--color-text-secondary);
      margin-bottom: 40px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .calendly-wrapper {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      min-height: 1000px;
    }
    .paused-page {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
    }
    .paused-inner {
      max-width: 560px;
      text-align: center;
    }
    .paused-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FEF3C7, #FDE68A);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 32px;
      font-size: 36px;
    }
    .paused-inner h1 {
      font-family: var(--font-display);
      font-size: clamp(28px, 5vw, 40px);
      font-weight: 400;
      line-height: 1.2;
      color: var(--color-text);
      margin-bottom: 20px;
    }
    .paused-inner .paused-body {
      font-size: 18px;
      line-height: 1.7;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
    }
    .paused-inner .paused-sub {
      font-size: 16px;
      line-height: 1.7;
      color: var(--color-text-muted);
    }

    /* Trust Banner */
    .trust-banner {
      background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
      padding: 64px 24px;
    }
    .trust-banner p {
      max-width: 720px;
      margin: 0 auto;
      text-align: center;
      font-size: 20px;
      line-height: 1.7;
      color: var(--color-navy);
      font-weight: 500;
    }

    /* Footer */
    .site-footer {
      background: var(--color-navy);
      padding: 40px 24px;
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .site-footer img { height: 24px; opacity: 0.9; }
    .site-footer p {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-inner {
        grid-template-columns: 1fr;
        gap: 32px;
      }
      .logo-card { padding: 24px; }
      .tips-toggle { font-size: 20px; padding: 20px 24px; }
      .tips-content { padding: 20px 24px 28px; }
      .tips-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body style={isAccepting ? '' : 'display:flex;flex-direction:column;min-height:100vh;'}>

  {isAccepting ? (
    <>
      <div class="header-banner">
        <header class="header">
          <img src="/shareone-logo-white.svg" alt="Share One" />
        </header>
        <section class="headline-banner">
          <div class="headline-banner-inner">
            <h1>{mainHeader}</h1>
            <p class="banner-description">{headerSubtext}</p>
          </div>
        </section>
      </div>

      <section class="hero">
        <div class="hero-inner">
          <div>
            <p class="invitation-headline">{headline}</p>
            <p class="invitation-description">{description}</p>
          </div>
          {page.logo_url && (
            <div class="logo-card">
              <img src={page.logo_url} alt={clientName} />
            </div>
          )}
        </div>
      </section>

      <section class="tips-section">
        <div class="tips-inner">
          <button class="tips-toggle" id="tips-toggle" aria-expanded="false" aria-controls="tips-content">
            <span>Quick Tips</span>
            <svg id="chevron-down" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
            <svg id="chevron-up" viewBox="0 0 24 24" style="display:none"><polyline points="18 15 12 9 6 15"></polyline></svg>
          </button>
          <div class="tips-content" id="tips-content">
            <p class="tips-subheading">Quiet space — find a well-lit, calm environment free from background noise</p>
            <div class="tips-grid">
              <div>
                <h4>Using a Phone</h4>
                <ul>
                  <li><span class="bullet"></span><span>Set it to landscape, not portrait</span></li>
                  <li><span class="bullet"></span><span>Use a phone stand, tripod, or prop it against stable objects</span></li>
                  <li><span class="bullet"></span><span>Position at eye level for the best angle</span></li>
                </ul>
              </div>
              <div>
                <h4>Using a Computer</h4>
                <ul>
                  <li><span class="bullet"></span><span>Position your laptop or webcam at eye level</span></li>
                  <li><span class="bullet"></span><span>Sit an arm's length away from the screen</span></li>
                  <li><span class="bullet"></span><span>Test your camera and microphone before the call</span></li>
                </ul>
              </div>
            </div>
            <p class="tips-footer">Still unsure? No problem — your guide will help you adjust everything when you join.</p>
          </div>
        </div>
      </section>

      <section class="schedule-section">
        <div class="schedule-inner">
          <h2>Choose a Time That Works for You</h2>
          <p class="subtitle">Select your preferred date and time below. You'll receive a confirmation email with your virtual meeting link and preparation tips.</p>
          <div class="calendly-wrapper">
            {isCalendlyEmbed ? (
              <Fragment set:html={calendlyEmbedHtml} />
            ) : calendlyUrl ? (
              <Fragment set:html={`
                <div class="calendly-inline-widget" data-url="${calendlyUrl}${calendlyUrl.includes('?') ? '&' : '?'}${utmParams}" style="min-width:320px;height:1000px;"></div>
                <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
              `} />
            ) : (
              <div style="padding: 48px; text-align: center; color: var(--color-text-muted);">
                <p>Scheduling will be available soon.</p>
              </div>
            )}
          </div>
        </div>
      </section>

      <section class="trust-banner">
        <p>We'll walk you through everything and help you prepare before we start. All you need is your device and a quiet space — we'll take care of the rest. No tech experience required.</p>
      </section>
    </>
  ) : (
    <>
      <header class="header" style="background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-accent) 100%);">
        <img src="/shareone-logo-white.svg" alt="Share One" />
      </header>
      <div class="paused-page">
        <div class="paused-inner">
          <div class="paused-icon">⏸</div>
          <h1>This Invitation Is Currently Paused</h1>
          <p class="paused-body">Thank you for being willing to share your experience. At this time, we are not accepting new interview bookings.</p>
          <p class="paused-sub">We recommend connecting with the person who invited you for next steps or additional details.</p>
        </div>
      </div>
    </>
  )}

  <footer class="site-footer">
    <img src="/shareone-logo-white.svg" alt="Share One" />
    <p>Thank you for inspiring someone today!</p>
  </footer>

  <!-- Quick Tips toggle script -->
  <script>
    const toggle = document.getElementById('tips-toggle');
    const content = document.getElementById('tips-content');
    const chevDown = document.getElementById('chevron-down');
    const chevUp = document.getElementById('chevron-up');
    
    toggle?.addEventListener('click', () => {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      toggle.setAttribute('aria-expanded', String(!expanded));
      content?.classList.toggle('open');
      if (chevDown && chevUp) {
        chevDown.style.display = expanded ? 'block' : 'none';
        chevUp.style.display = expanded ? 'none' : 'block';
      }
    });
  </script>

</body>
</html>
